<!doctype html>
<html>
    <head>
    <meta charset= "UTF-8">
    <title>Character Generation</title>
    <style>
        .schools li, ul.iskills {
            display: flex;
            flex-wrap: wrap;
            list-style: none;
            justify-content: space-evenly;
        }
        
        input[type=text] {
            width: 30px;
            margin-left: 10px;
            margin-right: 10px;
            display:inline;
        }
        
        input.long[type=text] {
            width:120px;
        }
        
        li {
            margin-left:5px;
            margin-righ:5px;
        }
    </style>
    </head>
    <body>
        <script src="mithril.js"></script>
        <script>
        let char;
        
        
        
        const Char = function (obj) {
            if (obj) {
                this.data = obj;
            } else {
                this.data = this.base();
            }
            this.derived = this.base();
            return this;
        };
        
        Object.assign(Char.prototype, (function () {
            const ret =  {
                derive : function () {
                    let char = this;
                    let level = this.level;
                    let hours = this.hours;
                    let data = char.data;
                    let der = char.derived;
                    der.hours = 0;
                
                    der.name = data.name;
                    der.race = data.race.toLowerCase();
                    char.presentAtt.forEach( 
                        function (att, ind) { 
                            const dh = data.attributes[att];
                            der.attributes[att] = level(hours.attributes, dh); 
                            const race = char.rolls.races.hasOwnProperty(der.race) ?
                                der.race : "human";
                            der.attributes[att] += char.rolls.races[race][ind];
                            der.hours += dh;
                        }
                    );
                     char.presentPoints.forEach( 
                        function (att) { 
                            let dh = data.points[att];
                            der.points[att] = Math.floor(dh/hours.points[att]) + 
                                char.rolls.points[att]; 
                            der.hours += dh;
                        }
                     );
                    let sk = der.skills;
                    data.skills.forEach(function (gval, gind) {
                        let gh = gval[1];
                        der.hours += gh;
                        let glevel = level(hours.skills.general, gh);
                        if (glevel === 3 ) {
                            let skSch = sk[gind][2];
                            gval[2].forEach(function (scval, scind) {
                                let schr = scval[1];
                                der.hours += schr;
                                let sclvl = level(hours.skills.school, schr);
                                const bonus = der.attributes[char.schAtt[gval[0]][scval[0]]];
                                if (sclvl === 3) {
                                    let skSk = skSch[scind][2];
                                    scval[2].forEach(function (skval, skind) {
                                        let skhr = skval[1];
                                        der.hours += skhr;
                                        let sklvl = level(hours.skills.skill, skhr);
                                        skSk[skind][1] = (char.rolls.skills.skill[sklvl-1] || '') + "+" + bonus;
                                    });
                                }
                                skSch[scind][1] = (char.rolls.skills.school[sclvl-1] || '') + "+" + bonus;
                            });
                        }
                        sk[gind][1] = char.rolls.skills.general[glevel-1];
                    });
                },
                level : function (arr, val) {
                    return arr.reduce( function (acc, cur) {
                        return (val >= cur ) ? acc + 1 : acc;
                    }, 0);
                },
                hours : {
                    attributes: [100, 200, 400, 800, 1600, 3200, 6400, 12800],
                    points : {
                        LP: 100,
                        SP: 200,
                        MP: 300
                    },
                    skills : {
                        general : [100, 200, 400],
                        school : [150, 300, 600],
                        skill : [100, 200, 400, 800, 1600, 3200, 500, 1000, 2000, 3000, 4000, 5000],
                    },
                    spells : [25,50,100, 200, 400,800,1600, 3200, 6400]
                },
                rolls : {
                    attributes : [1,2,3,4,5,6,7,8],
                    points : {
                        LP: 25,
                        SP: 5,
                        MP: 5},
                    skills : {
                        general : ["1d4", "1d6", "1d8"],
                        school : ["1d10", "1d12", "1d20"],
                        skill : ["1d12+8", "1d10+10", "1d8+12", "1d6+14", "1d4+16",
                        "+20", "1d4+20", "1d6+20", "1d8+20", "1d10+20", "1d12+20",
                        "1d20+20"],
                    },
                    spells : ["Lvl 1", "Lvl 2", "Lvl 3", "Lvl 4", "Lvl 5", "Lvl 6", 
                        "Lvl 7", "Lvl 8", "Lvl 9"],
                    races : {
                        human : [1,1,1,1,1,1],
                        elf : [0,2,0,0,0,0],
                        gnome : [0,0,2,0,0,0],
                        "half-elf" : [0,1,1,0,0,2],
                        tiefling : [0,0,1,0,0,2]
                    }
                },
                schAtt : {"Physical":{"Outdoor":"STR","Agility":"DEX","Toughness":"CON"},"Mental":{"Academic":"INT","Thinking":"INT","Survival":"WIS","Language":"INT"},"Combat":{"Unarmed":"STR","Slash":"STR","Bludgeoning":"STR","Piercing":"STR","Ranged":"DEX","Defense":"DEX"},"Magic":{"Elements":"INT","Spirits":"WIS","Defense Elements":"INT","Defense Spirits":"WIS"},"Social":{"Communication":"CHA","Entertain":"CHA","Animals":"WIS","Gaming":"INT","Artisan":"DEX"},"Awareness":{"Knowing":"WIS","Hide":"WIS","Movement":"DEX","Mechanical":"DEX","Keen Eye":"INT"}},
                base : function () {
                    return { race : 'human',
                        name : 'jd',
                        attributes : {
                                "STR": 0,
                                "DEX": 0,
                                "CON": 0,
                                "INT": 0,
                                "WIS": 0,
                                "CHA": 0
                        },
                        points : {
                            "LP" : 0,
                            "SP" : 0,
                            "MP" : 0,
                        },
                        skills : [["Physical",0,[["Outdoor",0,[["Swim",0],["Climb",0],["Run",0]]],["Agility",0,[["Tumble",0],["Escape Artist",0],["Juggling",0]]],["Toughness",0,[["Resist Poison",0],["Resist Disease",0]]]]],["Mental",0,[["Academic",0,[["History",0],["Nature",0],["Mathematics",0],["Science",0],["Law",0],["Ancient",0]]],["Thinking",0,[["Strategy",0],["Memory",0],["Deduction",0],["Engineering",0]]],["Survival",0,[["Heal",0],["Forage",0],["Track",0],["Knots",0],["Herbalism Kit",0],["Navigator's Kit",0]]],["Language",0,[["Common",0],["Dwarvish",0],["Elvish",0],["Giant",0],["Gnomish",0],["Goblin",0],["Halfling",0],["Orc",0],["Abyssal",0],["Celestial",0],["Draconic",0],["Deep Speech",0],["Infernal",0],["Primordial",0],["Sylvan",0],["Undercommon",0]]]]],["Combat",0,[["Unarmed",0,[["Wrestling",0],["Boxing +2",0],["Martial Arts +4",0]]],["Slash",0,[["Handaxe +3",0],["Sickle +2",0],["Battleaxe +4",0],["Glaive +5",0],["Greataxe +6",0],["Greatsword +6",0],["Halberd +5",0],["Longsword +4",0],["Scimitar +3",0],["Whip +2",0]]],["Bludgeoning",0,[["Club +2",0],["Greatclub +4",0],["Light Hammer +2",0],["Mace +3",0],["Quarterstaff +3",0],["Flail +4",0],["Maul +6",0],["Warhammer +8",0],["",0]]],["Piercing",0,[["Dagger +2",0],["Spear +3",0],["Lance +6",0],["Morningstar +4",0],["Pike +5",0],["Rapier +4",0],["Shortsword +3",0],["Trident +3",0],["War pick +4",0]]],["Ranged",0,[["Light Crossbow +4",0],["Dart + 2",0],["Shortbow +3",0],["Sling +2",0],["Blowgun +1",0],["Hand Crossbow +3",0],["Heavy Crossbow +5",0],["Longbow +4",0],["Net +0",0]]],["Defense",0,[["Dodge",0],["Parry",0],["Shield +2",0]]]]],["Magic",0,[["Elements",0,[["Fire",0],["Water",0],["Air",0],["Earth",0],["Light",0],["Physical",0]]],["Spirits",0,[["Life",0],["Death",0],["Mental",0],["Space-Time",0],["Force",0],["Magic",0]]],["Defense Elements",0,[["Fire",0],["Water",0],["Air",0],["Earth",0],["Light",0],["Physical",0]]],["Defense Spirits",0,[["Life",0],["Death",0],["Mental",0],["Space-Time",0],["Force",0],["Magic",0]]]]],["Social",0,[["Communication",0,[["Deception",0],["Persuasion",0],["Intimidate",0],["Bluff",0],["Etiquette",0]]],["Entertain",0,[["Singing",0],["Dancing",0],["Acting",0],["Lute",0],["Pan Flute",0],["Lyre",0],["Drum",0]]],["Animals",0,[["Riding",0],["Communicating",0],["Training",0],["Raising",0]]],["Gaming",0,[["Dice",0],["Dragonchess",0],["Playing Cards",0]]],["Artisan",0,[["Alchemist",0],["Brewer",0],["Calligrapher",0],["Carpenter",0],["Cartogapher",0],["Cobbler",0],["Cook",0],["Glassblower",0],["Jeweler",0],["Leatherworker",0],["Mason",0],["Painter",0],["Potter",0],["Smith",0],["Tinker",0],["Weaver",0],["Woodcarver",0]]]]],["Awareness",0,[["Knowing",0,[["Search",0],["Spot",0],["Gather Information",0],["Sense Motive",0]]],["Hide",0,[["Background Camouflage",0],["Disguise Kit",0],["Hide Tracks",0]]],["Movement",0,[["Move Silently",0],["Precision Movements",0],["Sleight of Hand",0]]],["Mechanical",0,[["Thieve's Tools",0],["Detect Traps",0],["Disable Device",0]]],["Keen Eye",0,[["Decipher Script",0],["Forgery Kit",0],["Appraise",0],["Poisoner's Kit",0]]]]]],
                        feats : {},
                        features : {} 
                    };
                },
                presentAtt : [ "STR", "DEX", "CON", "INT", "WIS", "CHA"],
                presentPoints : [ "LP", "SP", "MP" ],
                runsum : function (arr) {
                    var sum = 0;
                    arr.forEach(function (val, ind) {
                        sum += val;
                        arr[ind] = sum;
                    });
                }
            };
            const hours = ret.hours;
            const runsum = ret.runsum;
            runsum(hours.skills.general);
            runsum(hours.skills.school);
            runsum(hours.skills.skill);
            runsum(hours.attributes);
            return ret;
            })()
        );
        
        char = new Char();
        
        let iName = { view : function () {
         return  m("#iname.input", [
             m("label", "Name"),
             m("input.long[type=text]", {oninput: m.withAttr("value", setName , char), value: char.data.name}),
             m("span.out", char.data.name)
         ]);
        } };
        let oName = { view : function () {
         return m("#oname", "Name: " +char.data.name);
        } };
        const setName = function (value) {
            this.name = value;
            this.derive();
        };
        let iRace = { view : function () {
         return  m("#irace.input", [
            m("label", "Race"),
            m("input.long[type=text]", {oninput: m.withAttr("value", setRace , char), value: char.data.race}),
            m("span.out", char.data.race)
         ]);
        } };
        let oRace = { view : function () {
         return m("#orace", "Race: " + char.data.race);
        } };
        const setRace = function (value) {
            this.race = value;
            this.derive();
        };
        const setAtt = char.presentAtt.map(function (att) {
            return function (val) {
                val = char.data.attributes[att] = parseInt(val, 10) || 0;
                char.derive();
            };
        });
        const iAttributes = { view : function () {
         return m("ul#iAtt", 
           char.presentAtt.map(function (att, ind) {
             return m("li.input",  
                m("label", att),
                m("input[type=text]", {oninput: m.withAttr("value", setAtt[ind]), 
                    value:char.data.attributes[att]
                }),
                m("span.out",  char.derived.attributes[att])
             );
            })
        );
        } };
        const oAttributes = {view : function () {
         return m("ul#oAtt", 
           char.presentAtt.map(function (att) {
             return m("li", char.derived.attributes[att]);  
            })
        )    ;
        } };
        const setPoints = char.presentPoints.map(function (att) {
            return function (val) {
                val = char.data.points[att] = parseInt(val, 10) || 0;
                char.derive();
            };
        });
        const iPoints = { view : function () {
         return m("ul#iPoint", 
          char.presentPoints.map(function (att, ind) {
             return m("li.input",  
                m("label", att),
                m("input[type=text]", {oninput: m.withAttr("value", setPoints[ind]), 
                    value:char.data.points[att]
                }),
                m("span.out", att + ": +" + char.derived.points[att])
             );
            })
        );
        } };
        const oPoints = {view : function () {
         return m("ul#oPoint", 
           char.presentPoints.map(function (att) {
             return m("li", att + ": +" + char.derived.points[att]);  
            })
        )    ;
        } };
        const listener = function (val) { 
            this[1] = parseInt(val, 10) || 0; 
            char.derive();
        };
        const iSkills  = { view : function (vnode) {
         return m("ul.iskills", vnode.attrs.skills.map(
            function (skl, skind) {
                let gind = vnode.attrs.gind;
                let scind = vnode.attrs.scind;
                return m("li.input", 
                    m("label", skl[0]),
                    m("input[type=text]", {
                    oninput: m.withAttr("value", listener, skl),
                    value:skl[1] }),
                    m("span.out", char.derived.skills[gind][2][scind][2][skind][1])
                );
            }
        ));
        } };
        const iSchools = { view : function (vnode) {
         return m("ul.schools", vnode.attrs.schools.map(
            function (sch, scind) {
                var gind = vnode.attrs.gind;
                return m("li.input",
                    m(".group", 
                        m("label", sch[0]),
                        m("input[type=text]", {
                            oninput: m.withAttr("value", listener, sch),
                            value:sch[1] }),
                        m("span.out", char.derived.skills[gind][2][scind][1])
                    ),
                    m(iSkills, {skills: sch[2], gind:gind, scind: scind} )
            );}));
        } };
        const iGeneral = { view : function () {
         return m("ul#general", char.data.skills.map(function (gen, ind) {
            return m("li.input", 
                m(".group", 
                    m("label", gen[0]),
                    m("input[type=text]", {
                        oninput: m.withAttr("value", listener, gen),
                        value:gen[1] }),
                    m("span.out", char.derived.skills[ind][1])
                ),
                m(iSchools, {schools: gen[2], gind : ind })
            );
        }));
        } };
        const oHours = {view : function () {
         return m("#hours", "Hours Used: " + char.derived.hours );
        }};
        
        
        char.derive();
        
        const Input = { view : function () {
         return m("#input", [
                m("h1", "Character Creation"),
                m(iName),
                m(iRace),
                m(oHours),
                m(iAttributes),
                m(iPoints),
                m(iGeneral)
        
        ]);
        } };
        let id;
        const history = [];
        history.add = function (obj) {
            let str = JSON.stringify(obj);
            if (history.indexOf(str) === -1) {
                history.push(str);
            }
            return str;
        };
        history.get = function (cur) {
            let str = this[cur];
            return JSON.parse(str);
        };
        let cur = 0;
        const Save = { view : function () {
         return m("#save", 
            m("h1", "Saving and Loading"),
            m("label", "Unique Identifier:"),
            m("input.long[type=text]", {oninput: m.withAttr("value", function (val) {
                id = val;
            }), value : id}),
            m("button", {onclick: function () {
                let str = history.add(char.data);
                cur = history.length;
                localStorage.setItem(id, str);
            }}, "Save"),
            m("button", {onclick: function () {
                history.add(char.data);
                let str = localStorage.getItem(id);
                if (str) {
                    char.data = JSON.parse(str);
                } else {
                    console.log("no such item");
                }
            }}, "Load"),
            m("button", {onclick: function () {
                if (cur > 0) {
                    cur -= 1;
                    history.add(char.data);
                    char.data = history.get(cur);
                    char.derive();
                }
            }}, "Back"),
            m("button", {onclick: function () {
                if (cur < (history.length-1) ) {
                    cur += 1;
                    history.add(char.data);
                    char.data = history.get(cur);
                    char.derive();
                }
            }}, "Forward"),
            m("button", {onclick: function () {
                history.push(JSON.stringify(char.data));
                cur = history.length;
                char.data = char.base();
                char.derive();
            }}, "New")
        );
        } };
        
        
        
        const root = document.body;
        m.mount(root, { 
            view : function () {
             return [ m(Input), m(Save) ] ;
            } 
        });
    </script>
    </body>
</html>
