<!doctype html>
<html>
    <head>
    <meta charset= "UTF-8">
    <title>Character Generation</title>
    <style>
        .schools li, ul.iskills {
            display: flex;
            flex-wrap: wrap;
            list-style: none;
        }
        
        input[type=text] {
            width: 30px;
            margin-left: 10px;
            margin-right: 10px;
            display:inline;
        }
        
        input.long[type=text] {
            width:120px;
        }
        
        li {
            margin-left:5px;
            margin-righ:5px;
        }
        
        .hide {
            display:none !important;
        }
        
        span.out {
            padding-left: 5px;
            padding-right: 10px;
        }
    </style>
    </head>
    <body>
        <script src="mithril.js"></script>
        <script>
        let char;
        
        
        
        const Char = function (obj) {
            if (obj) {
                this.data = obj;
            } else {
                this.data = this.base();
            }
            this.derived = this.base();
            return this;
        };
        
        Object.assign(Char.prototype, (function () {
            const ret =  {
                derive : function () {
                    let char = this;
                    let level = this.level;
                    let hours = this.hours;
                    let data = char.data;
                    let der = char.derived;
                    der.hours = 0;
                
                    der.name = data.name;
                    der.race = data.race.toLowerCase();
                    char.presentAtt.forEach( 
                        function (att, ind) { 
                            const dh = data.attributes[att];
                            const race = char.hours.races.hasOwnProperty(der.race) ?
                                der.race : "human";
                            der.attributes[att] = level(hours.attributes, dh+ 
                                char.hours.races[race][ind]); 
                            der.hours += dh;
                        }
                    );
                     char.presentPoints.forEach( 
                        function (att) { 
                            let dh = data.points[att];
                            der.points[att] = level(hours.points[att], dh); 
                            der.hours += dh;
                        }
                     );
                    let sk = der.skills;
                    data.skills.forEach(function (gval, gind) {
                        let gh = gval[1];
                        der.hours += gh;
                        let glevel = level(hours.skills.general, gh);
                        let skSch = sk[gind][2];
                        gval[2].forEach(function (scval, scind) {
                            let schr = scval[1];
                            der.hours += schr;
                            let sclvl = glevel + level(hours.skills.school, schr);
                            const bonus = der.attributes[char.schAtt[gval[0]][scval[0]]];
                            let skSk = skSch[scind][2];
                            scval[2].forEach(function (skval, skind) {
                                let skhr = skval[1];
                                der.hours += skhr;
                                let sklvl = sclvl + level(hours.skills.skill, skhr);
                                skSk[skind][1] = char.rolls.skills[sklvl-1].
                                    map( (v,i) => ( (i === 0) ? v : v + bonus) );
                            });
                            skSch[scind][1] = char.rolls.skills[sclvl-1].
                                map( (v,i) => ( (i === 0) ? v : v + bonus));
                        });
                        sk[gind][1] = char.rolls.skills[glevel-1].
                            map(v => v);
                    });
                },
                level : function (arr, val) {
                    return arr.reduce( function (acc, cur) {
                        return (val >= cur ) ? acc + 1 : acc;
                    }, 0);
                },
                hours : {"skills":{"general":[0,225,675,2025,4878,10503,17253,25497,36000,47997,63747,74997,90000,105003,119997,142497,164997,195003,225000,262503,299997,337500,375003,420003,472500,524997,577503,630000,682497,749997],"school":[75,225,675,1626,3501,5751,8499,12000,15999,21249,24999,30000,35001,39999,47499,54999,65001,75000,87501,99999,112500,125001,140001,157500,174999,192501,210000,227499,249999],"skill":[25,75,225,542,1167,1917,2833,4000,5333,7083,8333,10000,11667,13333,15833,18333,21667,25000,29167,33333,37500,41667,46667,52500,58333,64167,70000,75833,83333]},"attributes":[500,1500,4500,10840,23340,38340,56660,80000],"races":{"human":[250,250,250,250,250,250],"elf":[0,500,0,0,0,0],"gnome":[0,0,0,500,0,0],"rock gnome":[0,0,250,0,0,0],"half-elf":[0,250,250,0,0,500],"tiefling":[0,0,250,0,0,500]},"points":{"LP":[0,0,0,0,0,5,10,15,20,25,35,45,55,65,75,105,135,165,195,225,288,351,414,477,540,665,790,915,1040,1165,1315,1465,1615,1765,1915,2098,2281,2464,2647,2830,3063,3296,3529,3762,3995,4261,4527,4793,5059,5325,5675,6025,6375,6725,7075,7325,7575,7825,8075,8325,8658,8991,9324,9657,9990,10323,10656,10989,11322,11655,11988,12321,12654,12987,13320,13820,14320,14820,15320,15820,16320,16820,17320,17820,18320,18986,19652,20318,20984,21650,22316,22982,23648,24314,24980,25813,26646,27479,28312,29145,29978,30811,31644,32477,33310,34143,34976,35809,36642,37475,38308,39141,39974,40807,41640,42640,43640,44640,45640,46640,47806,48972,50138,51304,52470,53636,54802,55968,57134,58300,59466,60632,61798,62964,64130,65296,66462,67628,68794,69960,71126,72292,73458,74624,75790,77290,78790,80290,81790,83290],"SP":[0,25,75,225,542,1167,1917,2833,4000,5333,7083,8333,10000,11667,13333,15833,18333,21667,25000,29167,33333,37500,41667,46667,52500,58333,64167,70000,75833,83333],"MP":[0,0,0,8,16,24,40,56,72,122,172,222,327,432,537,745,953,1161,1411,1661,1911,2216,2521,2826,3215,3604,3993,4437,4881,5325,5908,6491,7074,7490,7906,8322,8877,9432,9987,10542,11097,11652,12207,12762,13317,14150,14983,15816,16649,17482,18315,19426,20537,21648,22759,23870,24981,26370,27759,29148,30536,31924,33312,34701,36090,37479,38868,40257,41646,43312,44978,46644,48588,50532,52476,54420,56364,58308,60252,62196,64140,66084,68028,69972,71916,73860,75804,78304,80804,83304]},"spells":[12,112,583,1416,2666,4166,5833,7916,10833],"features":[50,150,450,1084,2334,3834,5666,8000,10666,14166,16666,20000,23334,26666,31666,36666,43334,50000,58334,66666,75000,83334,93334,105000,116666,128334,140000,151666,166666],"feats":4500},
                rolls : {
                    skills : [["1d4",0],["1d4",1],["1d6",1],["1d6",2],["1d8",2],["1d8",3],["1d10",3],["1d10",4],["1d12",4],["1d12",5],["1d10",7],["1d10",8],["1d8",10],["1d8",11],["1d6",13],["1d6",14],["1d4",16],["1d4",17],["1d6",17],["1d6",18],["1d8",18],["1d8",19],["1d10",19],["1d10",20],["1d12",20],["1d12",21],["1d10",23],["1d10",24],["1d8",26],["1d8",27]],
                    spells : [1,5,8,11,14,17,18,19,20,21,null,null,null,null]
                },
                schAtt : {"Physical":{"Outdoor":"STR","Agility":"DEX","Toughness":"CON"},"Mental":{"Academic":"INT","Thinking":"INT","Survival":"WIS"},"Combat":{"Unarmed":"STR","Slash":"STR","Bludgeoning":"STR","Piercing":"STR","Ranged":"DEX","Defense":"DEX"},"Magic":{"Elements":"INT","Spirits":"WIS","Defense Elements":"INT","Defense Spirits":"WIS"},"Social":{"Communication":"CHA","Entertain":"CHA","Animals":"WIS","Gaming":"INT","Artisan":"DEX"},"Awareness":{"Knowing":"WIS","Hide":"WIS","Movement":"DEX","Mechanical":"DEX","Keen Eye":"INT"},"Lingustics":{"Spoken":"CHA","Written":"INT"}},
                base : function () {
                    return { race : 'human',
                        name : 'jd',
                        attributes : {
                                "STR": 0,
                                "DEX": 0,
                                "CON": 0,
                                "INT": 0,
                                "WIS": 0,
                                "CHA": 0
                        },
                        points : {
                            "LP" : 0,
                            "SP" : 0,
                            "MP" : 0,
                        },
                        skills : [["Physical",0,[["Outdoor",0,[["Swim",0],["Climb",0],["Run",0]]],["Agility",0,[["Tumble",0],["Escape Artist",0],["Juggling",0]]],["Toughness",0,[["Resist Poison",0],["Resist Disease",0],["Resist Death",0]]]]],["Mental",0,[["Academic",0,[["History",0],["Nature",0],["Mathematics",0],["Science",0],["Law",0],["Ancient",0],["Arcana",0]]],["Thinking",0,[["Strategy",0],["Memory",0],["Deduction",0],["Engineering",0]]],["Survival",0,[["Heal",0],["Forage",0],["Track",0],["Knots",0],["Herbalism Kit",0],["Navigator's Kit",0]]]]],["Combat",0,[["Unarmed",0,[["Wrestling",0],["Boxing",0],["Martial Arts",0]]],["Slash",0,[["Handaxe",0],["Sickle",0],["Battleaxe",0],["Glaive",0],["Greataxe",0],["Greatsword",0],["Halberd",0],["Longsword",0],["Scimitar",0],["Whip",0]]],["Bludgeoning",0,[["Club",0],["Greatclub",0],["Light Hammer",0],["Mace",0],["Quarterstaff",0],["Flail",0],["Maul",0],["Warhammer",0],["",0]]],["Piercing",0,[["Dagger",0],["Spear",0],["Lance",0],["Morningstar",0],["Pike",0],["Rapier",0],["Shortsword",0],["Trident",0],["War pick",0]]],["Ranged",0,[["Light Crossbow",0],["Dart",0],["Shortbow",0],["Sling",0],["Blowgun",0],["Hand Crossbow",0],["Heavy Crossbow",0],["Longbow",0],["Net",0]]],["Defense",0,[["Dodge",0],["Parry",0],["Shield",0]]]]],["Magic",0,[["Elements",0,[["Fire",0],["Water",0],["Air",0],["Earth",0],["Light",0],["Physical",0]]],["Spirits",0,[["Life",0],["Death",0],["Mental",0],["Space-Time",0],["Force",0],["Magic",0]]],["Defense Elements",0,[["Fire",0],["Water",0],["Air",0],["Earth",0],["Light",0],["Physical",0]]],["Defense Spirits",0,[["Life",0],["Death",0],["Mental",0],["Space-Time",0],["Force",0],["Magic",0]]]]],["Social",0,[["Communication",0,[["Deception",0],["Persuasion",0],["Intimidate",0],["Bluff",0],["Etiquette",0]]],["Entertain",0,[["Singing",0],["Dancing",0],["Acting",0],["Lute",0],["Pan Flute",0],["Lyre",0],["Drum",0]]],["Animals",0,[["Riding",0],["Communicating",0],["Training",0],["Raising",0]]],["Gaming",0,[["Dice",0],["Dragonchess",0],["Playing Cards",0]]],["Artisan",0,[["Alchemist",0],["Brewer",0],["Calligrapher",0],["Carpenter",0],["Cartogapher",0],["Cobbler",0],["Cook",0],["Glassblower",0],["Jeweler",0],["Leatherworker",0],["Mason",0],["Painter",0],["Potter",0],["Smith",0],["Tinker",0],["Weaver",0],["Woodcarver",0]]]]],["Awareness",0,[["Knowing",0,[["Perception",0],["Search",0],["Spot",0],["Gather Information",0],["Sense Motive",0],["Read Lips",0]]],["Hide",0,[["Background Camouflage",0],["Disguise Kit",0],["Hide Tracks",0]]],["Movement",0,[["Move Silently",0],["Precision Movements",0],["Sleight of Hand",0]]],["Mechanical",0,[["Thieve's Tools",0],["Detect Traps",0],["Disable Device",0]]],["Keen Eye",0,[["Decipher/Encrypt Script",0],["Forgery Kit",0],["Appraise",0],["Poisoner's Kit",0]]]]],["Lingustics",0,[["Spoken",0,[["Common",0],["Dwarvish",0],["Elvish",0],["Giant",0],["Gnomish",0],["Goblin",0],["Halfling",0],["Orc",0],["Abyssal",0],["Celestial",0],["Draconic",0],["Deep Speech",0],["Infernal",0],["Primordial",0],["Sylvan",0],["Undercommon",0]]],["Written",0,[["Common",0],["Dwarvish",0],["Elvish",0],["Giant",0],["Gnomish",0],["Goblin",0],["Halfling",0],["Orc",0],["Abyssal",0],["Celestial",0],["Draconic",0],["Deep Speech",0],["Infernal",0],["Primordial",0],["Sylvan",0],["Undercommon",0]]]]]],
                        feats : {},
                        features : {},
                        extra : "Extra stuff"
                    };
                },
                presentAtt : [ "STR", "DEX", "CON", "INT", "WIS", "CHA"],
                presentPoints : [ "LP", "SP", "MP" ],
            };
            const hours = ret.hours;
            return ret;
            })()
        );
        
        char = new Char();
        
        let iName = { view : function () {
         return  m("#iname.input", [
             m("label", "Name"),
             m("input.long[type=text]", {oninput: m.withAttr("value", setName , char), value: char.data.name}),
             m("span.out", char.data.name)
         ]);
        } };
        let oName = { view : function () {
         return m("#oname", "Name: " +char.data.name);
        } };
        const setName = function (value) {
            this.data.name = value;
            this.derive();
        };
        let iRace = { view : function () {
         return  m("#irace.input", [
            m("label", "Race"),
            m("input.long[type=text]", {oninput: m.withAttr("value", setRace , char), value: char.data.race}),
            m("span.out", char.data.race)
         ]);
        } };
        let oRace = { view : function () {
         return m("#orace", "Race: " + char.data.race);
        } };
        const setRace = function (value) {
            this.data.race = value;
            this.derive();
        };
        const setAtt = char.presentAtt.map(function (att) {
            return function (val) {
                val = char.data.attributes[att] = parseInt(val, 10) || 0;
                char.derive();
            };
        });
        const iAttributes = { view : function () {
         return m("ul#iAtt", 
           char.presentAtt.map(function (att, ind) {
             return m("li.input",  
                m("label", att+": "),
                m("input[type=text]", {oninput: m.withAttr("value", setAtt[ind]), 
                    value:char.data.attributes[att]
                }),
                m("span.out",  "+" + char.derived.attributes[att])
             );
            })
        );
        } };
        const oAttributes = {view : function () {
         return m("ul#oAtt", 
           char.presentAtt.map(function (att) {
             return m("li", char.derived.attributes[att]);  
            })
        )    ;
        } };
        const setPoints = char.presentPoints.map(function (att) {
            return function (val) {
                val = char.data.points[att] = parseInt(val, 10) || 0;
                char.derive();
            };
        });
        const iPoints = { view : function () {
         return m("ul#iPoint", 
          char.presentPoints.map(function (att, ind) {
             return m("li.input",  
                m("label", att+": "),
                m("input[type=text]", {oninput: m.withAttr("value", setPoints[ind]), 
                    value:char.data.points[att]
                }),
                m("span.out", char.derived.points[att])
             );
            })
        );
        } };
        const oPoints = {view : function () {
         return m("ul#oPoint", 
           char.presentPoints.map(function (att) {
             return m("li", att + ": +" + char.derived.points[att]);  
            })
        )    ;
        } };
        const listener = function (val) { 
            this[1] = parseInt(val, 10) || 0; 
            char.derive();
        };
        const iSkills  = { view : function (vnode) {
         return m("ul.iskills", vnode.attrs.skills.map(
            function (skl, skind) {
                let gind = vnode.attrs.gind;
                let scind = vnode.attrs.scind;
                const schlval = vnode.attrs.schlval;
                const sklval = char.derived.skills[gind][2][scind][2][skind][1];
                return m("li.input", 
                    m("label", skl[0]),
                    m("input[type=text]", {
                    oninput: m.withAttr("value", listener, skl),
                    value:skl[1] }),
                    m("span.out", (sklval.join('') === (schlval.join('') ) ?
                        '' : ( (sklval[1] === 0) ? sklval[1] : sklval.join("+") )
                        ) )
                );
            }
        ));
        } };
        const iSchools = { view : function (vnode) {
         return m("ul.schools", vnode.attrs.schools.map(
            function (sch, scind) {
                const gind = vnode.attrs.gind;
                const schlval = char.derived.skills[gind][2][scind][1];
                return m("li.input",
                    m(".group", 
                        m("label", sch[0]),
                        m("input[type=text]", {
                            oninput: m.withAttr("value", listener, sch),
                            value:sch[1] }),
                        m("span.out", (schlval[1] === 0) ? schlval[0] :
                            schlval.join("+"))
                    ),
                    m(iSkills, {skills: sch[2], gind:gind, scind: scind,
                        schlval:schlval} )
            );}));
        } };
        const iGeneral = { view : function () {
         return m("ul#general", char.data.skills.map(function (gen, ind) {
            const genval = char.derived.skills[ind][1];
            return m("li.input", 
                m(".group", 
                    m("label", gen[0]),
                    m("input[type=text]", {
                        oninput: m.withAttr("value", listener, gen),
                        value:gen[1] }),
                    m("span.out", (genval[1] === 0) ? genval[0] : genval.join("+"))
                ),
                m(iSchools, {schools: gen[2], gind : ind })
            );
        }));
        } };
        const Extra = { view : function () {
         return m("label", "Extra info"),
        m("textarea#Extra[rows=10][cols=50]", {
            onchange: m.withAttr("value", (val) => {console.log(val); char.data.extra  = val;}), 
                value: char.data.extra}
            );
        } };
        const oHours = {view : function () {
         return m("#hours", "Hours Used: " + char.derived.hours );
        }};
        
        
        char.derive();
        
        const Input = { view : function () {
         return m("#input", [
                m("h1", "Character Creation", m("button", {onclick: toggleInputListener}, "Toggle Input")),
                m(iName),
                m(iRace),
                m(oHours),
                m(iAttributes),
                m(iPoints),
                m(iGeneral),
                m(Extra)
        
        ]);
        } };
        let id;
        const history = [];
        history.add = function (obj) {
            let str = JSON.stringify(obj);
            if (history.indexOf(str) === -1) {
                history.push(str);
            }
            return str;
        };
        history.get = function (cur) {
            let str = this[cur];
            return JSON.parse(str);
        };
        let cur = 0;
        const Save = { view : function () {
         return m("#save", 
            m("h1", "Saving and Loading"),
            m("label", "Unique Identifier:"),
            m("input.long[type=text]", {oninput: m.withAttr("value", function (val) {
                id = val;
                document.querySelector("title").text = val;
            }), value : id}),
            m("button", {onclick: function () {
                let str = history.add(char.data);
                cur = history.length;
                let old = localStorage.getItem(id);
                if (old) {
                   history.add(old); 
                }
                localStorage.setItem(id, str);
            }}, "Save"),
            m("button", {onclick: function () {
                history.add(char.data);
                let str = localStorage.getItem(id);
                if (str) {
                    char.data = JSON.parse(str);
                    history.add(char.data);
                    char.derive();
                } else {
                    console.log("no such item");
                }
            }}, "Load"),
            m("button", {onclick: function () {
                if (cur > 0) {
                    cur -= 1;
                    history.add(char.data);
                    char.data = history.get(cur);
                    char.derive();
                }
            }}, "Back"),
            m("button", {onclick: function () {
                if (cur < (history.length-1) ) {
                    cur += 1;
                    history.add(char.data);
                    char.data = history.get(cur);
                    char.derive();
                }
            }}, "Forward"),
            m("button", {onclick: function () {
                history.push(JSON.stringify(char.data));
                cur = history.length;
                char.data = char.base();
                char.derive();
            }}, "New")
        );
        } };
        
        const toggleInputListener = (function () {
            let showInput = true;
            return function () {
                showInput = !showInput;
                console.log(showInput);
                if (showInput) {
                    document.querySelectorAll(".hide").
                        forEach( el => el.classList.remove("hide")
                    );
                } else {
                    document.querySelectorAll("input").
                        forEach( el => el.classList.add("hide") );
                    document.querySelectorAll(".out").
                        forEach( function (el) {
                            if (el.textContent === '') {
                                //el.parentElement.classList.add("hide");
                            }
                        });
                }
                
            };
        
        })(); ;
        
        const root = document.body;
        m.mount(root, { 
            view : function () {
             return [ m(Input), m(Save) ] ;
            } 
        });
    </script>
    </body>
</html>
