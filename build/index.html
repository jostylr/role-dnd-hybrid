<!doctype html>
<html>
    <head>
    <meta charset= "UTF-8">
    <title>Character Generation</title>
    <style>
        .schools li, ul.iskills {
            display: flex;
            flex-wrap: wrap;
            list-style: none;
            justify-content: space-evenly;
        }
        
        input[type=text] {
            width: 30px;
            margin-left: 10px;
            margin-right: 10px;
            display:inline;
        }
        
        input.long[type=text] {
            width:120px;
        }
        
        li {
            margin-left:5px;
            margin-righ:5px;
        }
    </style>
    </head>
    <body>
        <script src="mithril.js"></script>
        <script>
        let char;
        
        
        
        const Char = function (obj) {
            if (obj) {
                this.data = obj;
            } else {
                this.data = this.base();
            }
            this.derived = this.base();
            return this;
        };
        
        Object.assign(Char.prototype, (function () {
            const ret =  {
                derive : function () {
                    let char = this;
                    let level = this.level;
                    let hours = this.hours;
                    let data = char.data;
                    let der = char.derived;
                    der.hours = 0;
                
                    der.name = data.name;
                    der.race = data.race.toLowerCase();
                    char.presentAtt.forEach( 
                        function (att, ind) { 
                            const dh = data.attributes[att];
                            der.attributes[att] = level(hours.attributes, dh); 
                            const race = char.rolls.races.hasOwnProperty(der.race) ?
                                der.race : "human";
                            der.attributes[att] += char.rolls.races[race][ind];
                            der.hours += dh;
                        }
                    );
                     char.presentPoints.forEach( 
                        function (att) { 
                            let dh = data.points[att];
                            der.points[att] = Math.floor(dh/hours.points[att]) + 
                                char.rolls.points[att]; 
                            der.hours += dh;
                        }
                     );
                    let sk = der.skills;
                    data.skills.forEach(function (gval, gind) {
                        let gh = gval[1];
                        der.hours += gh;
                        let glevel = level(hours.skills.general, gh);
                        if (glevel === 3 ) {
                            let skSch = sk[gind][2];
                            gval[2].forEach(function (scval, scind) {
                                let schr = scval[1];
                                der.hours += schr;
                                let sclvl = level(hours.skills.school, schr);
                                const bonus = der.attributes[char.schAtt[gval[0]][scval[0]]];
                                if (sclvl === 3) {
                                    let skSk = skSch[scind][2];
                                    scval[2].forEach(function (skval, skind) {
                                        let skhr = skval[1];
                                        der.hours += skhr;
                                        let sklvl = level(hours.skills.skill, skhr);
                                        skSk[skind][1] = (char.rolls.skills.skill[sklvl-1] || '') + "+" + bonus;
                                    });
                                }
                                skSch[scind][1] = (char.rolls.skills.school[sclvl-1] || '') + "+" + bonus;
                            });
                        }
                        sk[gind][1] = char.rolls.skills.general[glevel-1];
                    });
                },
                level : function (arr, val) {
                    return arr.reduce( function (acc, cur) {
                        return (val >= cur ) ? acc + 1 : acc;
                    }, 0);
                },
                hours : {"skills":{"general":[0,270,810,2430,5850,12600,20700,30600,43200,57600,76500,90000,108000,126000,148500,175500,202500,238500,274500,319500],"school":[90,270,810,1950,4200,6900,10200,14400,19200,25500,30000,36000,42000,49500,58500,67500,79500,91500,106500],"skill":[30,90,270,650,1400,2300,3400,4800,6400,8500,10000,12000,14000,16500,19500,22500,26500,30500,35500]},"attributes":[90,766,2133,4000,6500,10166],"points":{"LP":[0,0,0,0,0,0,0,0,0,0,3,6,9,12,15,18,21,24,27,30,36,42,48,54,60,66,72,78,84,90,108,126,144,162,180,198,216,234,252,270,308,346,384,422,460,498,536,574,612,650,725,800,875,950,1025,1100,1175,1250,1325,1400,1490,1580,1670,1760,1850,1940,2030,2120,2210,2300,2410,2520,2630,2740,2850,2960,3070,3180,3290,3400,3540,3680,3820,3960,4100,4240,4380,4520,4660,4800,4960,5120,5280,5440,5600,5760,5920,6080,6240,6400,6610,6820,7030,7240,7450,7660,7870,8080,8290,8500,8650,8800,8950,9100,9250,9400,9550,9700,9850,10000,10200,10400,10600,10800,11000,11200,11400,11600,11800,12000,12200,12400,12600,12800,13000,13200,13400,13600,13800,14000,14250,14500,14750,15000,15250,15500,15750,16000,16250,16500,16800,17100,17400,17700,18000,18300,18600,18900,19200,19500,19800,20100,20400,20700,21000,21300,21600,21900,22200,22500,22900,23300,23700,24100,24500,24900,25300,25700,26100,26500,26900,27300,27700,28100,28500,28900,29300,29700,30100,30500,31000,31500,32000,32500,33000,33500,34000,34500,35000,35500],"SP":[0,30,90,270,650,1400,2300,3400,4800,6400,8500,10000,12000,14000,16500,19500,22500,26500,30500,35500],"MP":[0,0,0,0,0,6,12,18,24,30,42,54,66,78,90,126,162,198,234,270,346,422,498,574,650,800,950,1100,1250,1400,1580,1760,1940,2120,2300,2520,2740,2960,3180,3400,3680,3960,4240,4520,4800,5120,5440,5760,6080,6400,6820,7240,7660,8080,8500,8800,9100,9400,9700,10000,10400,10800,11200,11600,12000,12400,12800,13200,13600,14000,14500,15000,15500,16000,16500,17100,17700,18300,18900,19500,20100,20700,21300,21900,22500,23300,24100,24900,25700,26500,27300,28100,28900,29700,30500,31500,32500,33500,34500,35500]},"spells":[45,325,1150,2400,4250,6000,8250,11250,15250],"features":[60,180,540,1300,2800,4600,6800,9600,12800,17000,20000,24000,28000,33000,39000,45000,53000,61000,71000],"feats":2133},
                rolls : {
                    attributes : [1,2,3,4,5,6,7,8],
                    points : {
                        LP: 25,
                        SP: 5,
                        MP: 5},
                    skills : {
                        general : ["1d4", "1d6", "1d8"],
                        school : ["1d10", "1d12", "1d20"],
                        skill : ["1d12+8", "1d10+10", "1d8+12", "1d6+14", "1d4+16",
                        "+20", "1d4+20", "1d6+20", "1d8+20", "1d10+20", "1d12+20",
                        "1d20+20"],
                    },
                    spells : ["Lvl 1", "Lvl 2", "Lvl 3", "Lvl 4", "Lvl 5", "Lvl 6", 
                        "Lvl 7", "Lvl 8", "Lvl 9"],
                    races : {
                        human : [1,1,1,1,1,1],
                        elf : [0,2,0,0,0,0],
                        gnome : [0,0,0,2,0,0],
                        "rock gnome" : [0,0,1,0,0,0],
                        "half-elf" : [0,1,1,0,0,2],
                        tiefling : [0,0,1,0,0,2]
                    }
                },
                schAtt : {"Physical":{"Outdoor":"STR","Agility":"DEX","Toughness":"CON"},"Mental":{"Academic":"INT","Thinking":"INT","Survival":"WIS","Language":"INT"},"Combat":{"Unarmed":"STR","Slash":"STR","Bludgeoning":"STR","Piercing":"STR","Ranged":"DEX","Defense":"DEX"},"Magic":{"Elements":"INT","Spirits":"WIS","Defense Elements":"INT","Defense Spirits":"WIS"},"Social":{"Communication":"CHA","Entertain":"CHA","Animals":"WIS","Gaming":"INT","Artisan":"DEX"},"Awareness":{"Knowing":"WIS","Hide":"WIS","Movement":"DEX","Mechanical":"DEX","Keen Eye":"INT"}},
                base : function () {
                    return { race : 'human',
                        name : 'jd',
                        attributes : {
                                "STR": 0,
                                "DEX": 0,
                                "CON": 0,
                                "INT": 0,
                                "WIS": 0,
                                "CHA": 0
                        },
                        points : {
                            "LP" : 0,
                            "SP" : 0,
                            "MP" : 0,
                        },
                        skills : [["Physical",0,[["Outdoor",0,[["Swim",0],["Climb",0],["Run",0]]],["Agility",0,[["Tumble",0],["Escape Artist",0],["Juggling",0]]],["Toughness",0,[["Resist Poison",0],["Resist Disease",0]]]]],["Mental",0,[["Academic",0,[["History",0],["Nature",0],["Mathematics",0],["Science",0],["Law",0],["Ancient",0]]],["Thinking",0,[["Strategy",0],["Memory",0],["Deduction",0],["Engineering",0]]],["Survival",0,[["Heal",0],["Forage",0],["Track",0],["Knots",0],["Herbalism Kit",0],["Navigator's Kit",0]]],["Language",0,[["Common",0],["Dwarvish",0],["Elvish",0],["Giant",0],["Gnomish",0],["Goblin",0],["Halfling",0],["Orc",0],["Abyssal",0],["Celestial",0],["Draconic",0],["Deep Speech",0],["Infernal",0],["Primordial",0],["Sylvan",0],["Undercommon",0]]]]],["Combat",0,[["Unarmed",0,[["Wrestling",0],["Boxing",0],["Martial Arts",0]]],["Slash",0,[["Handaxe",0],["Sickle",0],["Battleaxe",0],["Glaive",0],["Greataxe",0],["Greatsword",0],["Halberd",0],["Longsword",0],["Scimitar",0],["Whip",0]]],["Bludgeoning",0,[["Club",0],["Greatclub",0],["Light Hammer",0],["Mace",0],["Quarterstaff",0],["Flail",0],["Maul",0],["Warhammer",0],["",0]]],["Piercing",0,[["Dagger",0],["Spear",0],["Lance",0],["Morningstar",0],["Pike",0],["Rapier",0],["Shortsword",0],["Trident",0],["War pick",0]]],["Ranged",0,[["Light Crossbow",0],["Dart",0],["Shortbow",0],["Sling",0],["Blowgun",0],["Hand Crossbow",0],["Heavy Crossbow",0],["Longbow",0],["Net",0]]],["Defense",0,[["Dodge",0],["Parry",0],["Shield",0]]]]],["Magic",0,[["Elements",0,[["Fire",0],["Water",0],["Air",0],["Earth",0],["Light",0],["Physical",0]]],["Spirits",0,[["Life",0],["Death",0],["Mental",0],["Space-Time",0],["Force",0],["Magic",0]]],["Defense Elements",0,[["Fire",0],["Water",0],["Air",0],["Earth",0],["Light",0],["Physical",0]]],["Defense Spirits",0,[["Life",0],["Death",0],["Mental",0],["Space-Time",0],["Force",0],["Magic",0]]]]],["Social",0,[["Communication",0,[["Deception",0],["Persuasion",0],["Intimidate",0],["Bluff",0],["Etiquette",0]]],["Entertain",0,[["Singing",0],["Dancing",0],["Acting",0],["Lute",0],["Pan Flute",0],["Lyre",0],["Drum",0]]],["Animals",0,[["Riding",0],["Communicating",0],["Training",0],["Raising",0]]],["Gaming",0,[["Dice",0],["Dragonchess",0],["Playing Cards",0]]],["Artisan",0,[["Alchemist",0],["Brewer",0],["Calligrapher",0],["Carpenter",0],["Cartogapher",0],["Cobbler",0],["Cook",0],["Glassblower",0],["Jeweler",0],["Leatherworker",0],["Mason",0],["Painter",0],["Potter",0],["Smith",0],["Tinker",0],["Weaver",0],["Woodcarver",0]]]]],["Awareness",0,[["Knowing",0,[["Search",0],["Spot",0],["Gather Information",0],["Sense Motive",0]]],["Hide",0,[["Background Camouflage",0],["Disguise Kit",0],["Hide Tracks",0]]],["Movement",0,[["Move Silently",0],["Precision Movements",0],["Sleight of Hand",0]]],["Mechanical",0,[["Thieve's Tools",0],["Detect Traps",0],["Disable Device",0]]],["Keen Eye",0,[["Decipher Script",0],["Forgery Kit",0],["Appraise",0],["Poisoner's Kit",0]]]]]],
                        feats : {},
                        features : {},
                        extra : "Extra stuff"
                    };
                },
                presentAtt : [ "STR", "DEX", "CON", "INT", "WIS", "CHA"],
                presentPoints : [ "LP", "SP", "MP" ],
            };
            const hours = ret.hours;
            return ret;
            })()
        );
        
        char = new Char();
        
        let iName = { view : function () {
         return  m("#iname.input", [
             m("label", "Name"),
             m("input.long[type=text]", {oninput: m.withAttr("value", setName , char), value: char.data.name}),
             m("span.out", char.data.name)
         ]);
        } };
        let oName = { view : function () {
         return m("#oname", "Name: " +char.data.name);
        } };
        const setName = function (value) {
            this.data.name = value;
            this.derive();
        };
        let iRace = { view : function () {
         return  m("#irace.input", [
            m("label", "Race"),
            m("input.long[type=text]", {oninput: m.withAttr("value", setRace , char), value: char.data.race}),
            m("span.out", char.data.race)
         ]);
        } };
        let oRace = { view : function () {
         return m("#orace", "Race: " + char.data.race);
        } };
        const setRace = function (value) {
            this.data.race = value;
            this.derive();
        };
        const setAtt = char.presentAtt.map(function (att) {
            return function (val) {
                val = char.data.attributes[att] = parseInt(val, 10) || 0;
                char.derive();
            };
        });
        const iAttributes = { view : function () {
         return m("ul#iAtt", 
           char.presentAtt.map(function (att, ind) {
             return m("li.input",  
                m("label", att),
                m("input[type=text]", {oninput: m.withAttr("value", setAtt[ind]), 
                    value:char.data.attributes[att]
                }),
                m("span.out",  char.derived.attributes[att])
             );
            })
        );
        } };
        const oAttributes = {view : function () {
         return m("ul#oAtt", 
           char.presentAtt.map(function (att) {
             return m("li", char.derived.attributes[att]);  
            })
        )    ;
        } };
        const setPoints = char.presentPoints.map(function (att) {
            return function (val) {
                val = char.data.points[att] = parseInt(val, 10) || 0;
                char.derive();
            };
        });
        const iPoints = { view : function () {
         return m("ul#iPoint", 
          char.presentPoints.map(function (att, ind) {
             return m("li.input",  
                m("label", att),
                m("input[type=text]", {oninput: m.withAttr("value", setPoints[ind]), 
                    value:char.data.points[att]
                }),
                m("span.out", att + ": +" + char.derived.points[att])
             );
            })
        );
        } };
        const oPoints = {view : function () {
         return m("ul#oPoint", 
           char.presentPoints.map(function (att) {
             return m("li", att + ": +" + char.derived.points[att]);  
            })
        )    ;
        } };
        const listener = function (val) { 
            this[1] = parseInt(val, 10) || 0; 
            char.derive();
        };
        const iSkills  = { view : function (vnode) {
         return m("ul.iskills", vnode.attrs.skills.map(
            function (skl, skind) {
                let gind = vnode.attrs.gind;
                let scind = vnode.attrs.scind;
                return m("li.input", 
                    m("label", skl[0]),
                    m("input[type=text]", {
                    oninput: m.withAttr("value", listener, skl),
                    value:skl[1] }),
                    m("span.out", char.derived.skills[gind][2][scind][2][skind][1])
                );
            }
        ));
        } };
        const iSchools = { view : function (vnode) {
         return m("ul.schools", vnode.attrs.schools.map(
            function (sch, scind) {
                var gind = vnode.attrs.gind;
                return m("li.input",
                    m(".group", 
                        m("label", sch[0]),
                        m("input[type=text]", {
                            oninput: m.withAttr("value", listener, sch),
                            value:sch[1] }),
                        m("span.out", char.derived.skills[gind][2][scind][1])
                    ),
                    m(iSkills, {skills: sch[2], gind:gind, scind: scind} )
            );}));
        } };
        const iGeneral = { view : function () {
         return m("ul#general", char.data.skills.map(function (gen, ind) {
            return m("li.input", 
                m(".group", 
                    m("label", gen[0]),
                    m("input[type=text]", {
                        oninput: m.withAttr("value", listener, gen),
                        value:gen[1] }),
                    m("span.out", char.derived.skills[ind][1])
                ),
                m(iSchools, {schools: gen[2], gind : ind })
            );
        }));
        } };
        const Extra = { view : function () {
         return m("label", "Extra info"),
        m("textarea#Extra[rows=10][cols=50]", {
            onchange: m.withAttr("value", (val) => {console.log(val); char.data.extra  = val;}), 
                value: char.data.extra}
            );
        } };
        const oHours = {view : function () {
         return m("#hours", "Hours Used: " + char.derived.hours );
        }};
        
        
        char.derive();
        
        const Input = { view : function () {
         return m("#input", [
                m("h1", "Character Creation"),
                m(iName),
                m(iRace),
                m(oHours),
                m(iAttributes),
                m(iPoints),
                m(iGeneral),
                m(Extra)
        
        ]);
        } };
        let id;
        const history = [];
        history.add = function (obj) {
            let str = JSON.stringify(obj);
            if (history.indexOf(str) === -1) {
                history.push(str);
            }
            return str;
        };
        history.get = function (cur) {
            let str = this[cur];
            return JSON.parse(str);
        };
        let cur = 0;
        const Save = { view : function () {
         return m("#save", 
            m("h1", "Saving and Loading"),
            m("label", "Unique Identifier:"),
            m("input.long[type=text]", {oninput: m.withAttr("value", function (val) {
                id = val;
            }), value : id}),
            m("button", {onclick: function () {
                let str = history.add(char.data);
                cur = history.length;
                let old = localStorage.getItem(id);
                if (old) {
                   history.add(old); 
                }
                localStorage.setItem(id, str);
            }}, "Save"),
            m("button", {onclick: function () {
                history.add(char.data);
                let str = localStorage.getItem(id);
                if (str) {
                    char.data = JSON.parse(str);
                    history.add(char.data);
                } else {
                    console.log("no such item");
                }
            }}, "Load"),
            m("button", {onclick: function () {
                if (cur > 0) {
                    cur -= 1;
                    history.add(char.data);
                    char.data = history.get(cur);
                    char.derive();
                }
            }}, "Back"),
            m("button", {onclick: function () {
                if (cur < (history.length-1) ) {
                    cur += 1;
                    history.add(char.data);
                    char.data = history.get(cur);
                    char.derive();
                }
            }}, "Forward"),
            m("button", {onclick: function () {
                history.push(JSON.stringify(char.data));
                cur = history.length;
                char.data = char.base();
                char.derive();
            }}, "New")
        );
        } };
        
        
        
        const root = document.body;
        m.mount(root, { 
            view : function () {
             return [ m(Input), m(Save) ] ;
            } 
        });
    </script>
    </body>
</html>
