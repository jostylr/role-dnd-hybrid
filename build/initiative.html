<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title></title>
    </head>
    <body>
        <textarea rows="20" cols="100"></textarea>
        <button>Process action</button>
        <div id="table"></div>
        <script>
            let textarea = document.querySelector("textarea");
            let tabby = document.querySelector("#table");
            let button = document.querySelector("button");
            
            let makeTable = function (queue) {
                let table = "<table><tbody><tr><td>" + 
                    queue.map( (el) => {
                       let char = chars[el];
                       let keys = Object.keys(char);
                       keys = keys.filter( el => (
                           (el !== "action") && 
                           (el !== "factor") )
                       );
                       let ret = keys.map(el => el + ":" + char[el]);
                       ret.unshift(el, char.action.toFixed(2), char.factor);
                       return ret.join("</td><td>");  
                    }).join("</td></tr><tr><td>") +
                    "</td></tr></tbody></table>";
                tabby.innerHTML = table;
            };
            
            let chars = {};
            let currentAction = 0;
            
            let rank = function () {
                let ret = Object.keys(chars);
                ret.sort( (a,b) => chars[a].action - chars[b].action );
                currentAction += ret[0];
                return ret;
            };
            
            let linePro = function (pieces) {
                pieces = pieces.map( el => 
                    (el[el.length-1] === ',') ? 
                        el.slice(0,-1) :
                        el
                );
            
            
                let name = pieces.shift();
            
                var char = chars[name];
                if (!char) {
                   char = chars[name] = {
                       action : 0,
                       factor : 1
                   };
                }
            
                pieces.sort().forEach( (el) => {
                    let action = parseFloat(el);
                    if (!isNaN(action)) {
                        char.action += action+Math.random()*0.1;
                        return;
                    }
                    if (el[0] === '*') {
                        char.factor = parseFloat(el.slice(1));
                        return;
                    }
                    let m = el.match(/(\w+)\:((\+|\-)?\d+(\.\d+)?)/);
                    if (m) {
                        let att = m[1];
                        let prop = parseFloat(m[2]);
                        if (char.hasOwnProperty(att) ) {
                            char[att] += prop;
                        } else {
                            char[att] = prop;
                        }
                        return;
                    }
                    if (el === '!') {
                        delete chars[name];
                        return;
                    }
                });
            
            
            };
            
            let linesPro = function (text) {
                let lines = text.split("\n").map( el => el.trim() );
                lines.forEach( (line) => {
                    if (line) {
                       linePro(line.split(/\s+/)); 
                    }
                });
            };
            
            button.addEventListener("click", function () {
                let val = textarea.value;
                if (val) {
                    linesPro(textarea.value);
                }
                textarea.value = '';
                    
                makeTable(rank() );
            
            });
        </script>
    </body>
</html>
