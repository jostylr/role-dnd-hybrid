<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title></title>
    </head>
    <body>
        <textarea rows="20" cols="100"></textarea>
        <button>Process action</button>
        <div id="table"></div>
        <script>
            let textarea = document.querySelector("textarea");
            let tabby = document.querySelector("#table");
            let button = document.querySelector("button");
            
            let makeTable = function () {
                let table = "<table><tbody><tr><td>" + 
                    queue.
                        map((el) => el.join("</td><td>") ).
                        join("</td></tr><tr><td>") + 
                    "</td></tr></tbody></table>";
                tabby.innerHTML = table;
            };
            
            let queue = [];
            let currentAction = 0;
            let add = function (name, initial=5, factor= 1) {
                queue.push([name, initial+currentAction, factor]);
            };
            let update = function (name, action) {
               queue.forEach(
                    function (el) {
                        if (el[0] === name) {
                            if (action > 0) {
                                el[1] += action*el[2];
                            } else {
                                el[1] += action;
                            }
                        }
                    }
                );
            };
            let modify = function (name, factor) {
                queue.forEach(
                    function (el) {
                        if (el[0] === name) {
                            el[2] = factor;
                        }
                    }
                );
            };
            let remove = function (name) {
                queue = queue.filter( (el) => (el[0] !== name) );
            };
            let iterate = function (a,b) {
               return a[1] - b[1];   
            };
            
            let input = function (text) {
            
                let lines = text.split("\n");
                lines.forEach(function (line) {
                    if (!line) { return;}
                    let parts = line.split(",").map( (el) => el.trim() );
                    if (parts.length === 1) {
                        remove(parts[0]);
                    }
                    switch (parts[1][0]) {
                        case '+' : 
                            update(parts[0], parseFloat(parts[1]));
                        break;
                        case '-' :
                            update(parts[0], parseFloat(parts[1]));
                        break;
                        case '*' :
                            modify(parts[0], parseFloat(parts[1].slice(1)));
                        break;
                        default  : 
                            add(parts[0], parseFloat(parts[1]), parseFloat(parts[2]) || 1); 
                        break;
                    }
                });
                queue.sort(iterate);
                currentAction = queue[0][1];
            };
            
            button.addEventListener("click", function () {
                let val = textarea.value;
                if (val) {
                    input(textarea.value);
                }
                textarea.value = '';
                    
                makeTable();
            
            });
        </script>
    </body>
</html>
